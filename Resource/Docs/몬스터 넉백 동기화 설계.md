# 몬스터 넉백 동기화 설계

## 1. 개요

본 문서는 플레이어의 근접 공격 시 발생하는 몬스터의 넉백 처리를 클라이언트 예측 이동과 서버 권위 위치 보정 방식으로 동기화하는 로직을 정의한다.

### 2. 클라이언트 로직

#### 2.1 공격 및 예측 시작

- 피격 판정: 플레이어의 근접 공격 애니메이션의 특정 프레임에서 공격 범위 내 적(Monster)을 탐색한다.
- 패킷 송신: 서버에 `C_MeleeAttack` 패킷 송신
- 예측 넉백: 서버의 응답을 기다리지 않고, 즉시 적의 상태를 `Damaged`로 변경하여 미리 정의된 넉백 공식에 따라 예상 위치로 이동 시작

#### 2.2 이동 및 상태 전이

- 로직 위치 보간: `FixedUpdate`에서 로직 위치를 예상 위치로 보간
- 비주얼 위치 보간: `Update`에서 비주얼 위치를 로직 위치로 보간
- 상태 종료: 로직 위치와 예상 위치 사이의 거리가 임계값 미만일 때,  
  `Idle`상태로 변경 후 `Damaged` 상태를 빠져나갈 때 비주얼 위치를 마지막으로 로직 위치로 보간하여 동기화

#### 2.3 서버 데이터 동기화

- 위치 수신: 서버로부터 `S_MeleeAttack` 패킨 수신 후 실제로 `Damaged` 상태의 적들을 찾아 `Damaged` 상태로 변경 및 넉백된 위치와 넉백 방향을 적용
- 보정 처리: 이미 `Damaged`가 진행중이었어도 실제 넉백 위치로 갱신했기 때문에 동기화되며,  
  다른 플레이어의 넉백 방향도 반영되었기 때문에 추가 공격시에도 실제 넉백 방향에 로컬 플레이어의 넉백 방향을 중첩시켜 넉백 방향도 동기화 된다.

### 3. 서버 로직

#### 3.1 공격 검증 및 계산

- 패킷 수신: 클라이언트로부터 `C_MeleeAttack` 패킷을 수신 후 플레이어의 위치, 공격 범위, 몬스터의 위치를 대조하여 유효성 검사
- 최종 위치 결정: `예상 위치 = 현재 위치 + 중첩된 넉백 방향 * 넉백 속도 * 넉백 총 시간` 으로 서버에서도 목적 예상 위치를 동일하게 계산한다.
- 실시간 위치 처리: 예상 위치로 현재 위치를 보간하여 이동한다.

#### 3.2 데이터 송신

- 검증한 예상 위치, 최종 넉백 방향 정보를 `S_MeleeAttack` 패킷에 담아 모든 클라이언트에게 브로드 캐스트
